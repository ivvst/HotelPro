<table *ngIf="excursions.length" class="exc-table">
  <thead>
    <tr>
      <th>Име</th>
      <th>Дата</th>
      <th>От</th>
      <th>До</th>
      <th>Описание</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody>
    <ng-container *ngFor="let ex of excursions">
      <tr>
        <td>
          {{ ex.name }}
          <span *ngIf="ex.deleteRequested" class="flag-delete" title="Маркирана за изтриване">⛔</span>

          <!-- метрики под името -->
          <div class="x-metrics">
            <span class="cap">Капацитет: {{ ex.capacity ?? 0 }}</span>
            <span class="wl">Чакащи: {{ ex.waitlist?.length || 0 }}</span>
          </div>
        </td>
        <td>{{ ex.date ? (ex.date | date:'dd/MM/yyyy') : '-' }}</td>
        <td>{{ ex.fromTime || '-' }}</td>
        <td>{{ ex.toTime || '-' }}</td>
        <td>{{ (ex.description || '-') | shorten:50 }}</td>
        <td>
          <button *ngIf="isAdmin" (click)="startEdit(ex)">Редактирай</button>
          <button *ngIf="isAdmin" (click)="deleteExcursion(ex._id!)">Изтрий</button>
          <button *ngIf="ex.deleteRequested && isAdmin" (click)="rejectDelete(ex._id)">Откажи изтриване</button>
          <button *ngIf="!isAdmin && !ex.deleteRequested" (click)="requestDelete(ex._id)">Маркирай за изтриване</button>
          <span *ngIf="!isAdmin && ex.deleteRequested" class="flag-delete-text">Изчаква одобрение</span>

          <!-- бутон за гости -->
          <button (click)="toggleGuests(ex._id)">Покажи гости</button>

          <!-- Инлайн смяна на капацитет (само за админ) -->
          <div *ngIf="isAdmin" class="cap-inline">
            <input type="number" min="1" max="20" class="capacity-input" [value]="ex.capacity || 1"
              (change)="saveCapacity(ex, $event)" />

          </div>
        </td>
      </tr>

      <!-- Ред с гостите -->
      <tr *ngIf="expanded[ex._id || '']">
        <td colspan="6">
          <div *ngIf="loadingGuests[ex._id || '']" class="loading-overlay">
            Зареждане на гости...
          </div>

          <div *ngIf="errorByExcursion[ex._id || '']" class="error">
            {{ errorByExcursion[ex._id || ''] }}
          </div>

          <ul *ngIf="guestsByExcursion[ex._id || '']?.length" class="guest-list">
            <li *ngFor="let g of guestsByExcursion[ex._id || '']">
              {{ g.firstName }} {{ g.lastName }} (Стая: {{ g.roomNumber || 'N/A' }})
            </li>
          </ul>

          <div *ngIf="!guestsByExcursion[ex._id || '']?.length && !loadingGuests[ex._id || '']" class="empty">
            Няма записани гости за тази екскурзия.
          </div>
        </td>
      </tr>
    </ng-container>
  </tbody>
</table>